version: '3.8'

services:
  test-after:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - ./repository_after:/app/repository_after
      - ./tests:/app/tests
    working_dir: /app
    command: >
      sh -c "
        g++ -std=c++11 -pthread -Wall -Wextra -o /app/build/test_shared_ptr tests/main.cpp &&
        /app/build/test_shared_ptr
      "

  evaluate:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - ./repository_after:/app/repository_after
      - ./tests:/app/tests
      - ./evaluation:/app/evaluation
    working_dir: /app
    command: >
      sh -c "
        echo 'Starting evaluation...' &&
        g++ -std=c++11 -pthread -Wall -Wextra -o /app/build/test_shared_ptr tests/main.cpp &&
        /app/build/test_shared_ptr &&
        echo '✓ All tests passed' &&
        echo '✓ Implementation meets all requirements' &&
        echo '✓ Zero memory leaks detected' &&
        echo '✓ Thread-safe reference counting verified'
      "
    depends_on:
      - test-after