services:
  test-before:
    build: .
    volumes:
      - .:/app
    command: >
      bash -c "
      if [ ! -f repository_before/CMakeLists.txt ]; then
        echo 'No CMakeLists.txt in repository_before. Skipping build.';
      else
        cd repository_before && mkdir -p build && cd build && cmake .. && make;
      fi &&
      cd /app && TARGET_REPO=repository_before pytest -q tests || true
      " 

  test-after:
    build: .
    volumes:
      - .:/app
    command: >
      bash -c "
      cd repository_after && mkdir -p build && cd build && cmake .. && make &&
      cd /app && TARGET_REPO=repository_after pytest -q tests
      "

  evaluation:
    build: .
    volumes:
      - .:/app
    command: python3 evaluation/evaluation.py
