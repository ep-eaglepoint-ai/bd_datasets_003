services:
  # The tests service is used by the evaluator to run Vitest on specific code states
  # The context will be either repository_before or repository_after
  tests:
    build:
      context: ./${REPO_PATH:-repository_after}
      dockerfile: ../Dockerfile
    command: npm test
    volumes:
      - ${HOST_PROJECT_PATH:-.}/tests:/app/tests
    # No ports needed for tests

  # The evaluator service orchestrates the tests service
  evaluator:
    build:
      context: ./repository_after
      dockerfile: ../Dockerfile
    command: sh -c "npx -y tsx evaluation/evaluation.ts"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/project
    working_dir: /project
    environment:
      - REPO_PATH=repository_after
      - HOST_PROJECT_PATH=${PWD}
