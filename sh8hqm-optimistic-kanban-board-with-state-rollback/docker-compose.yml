services:
  tester-before:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_before
    container_name: kanban-tester-before
    environment:
      TARGET_REPO: repository_before
    volumes:
      - .:/app
      - /app/repository_before/node_modules
      - /app/repository_after/node_modules
    command: ["sh", "-c", "cd repository_before && ([ -f package.json ] && npm test || echo 'No package.json in repository_before') && exit 0"]

  tester-after:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_after
    container_name: kanban-tester-after
    environment:
      TARGET_REPO: repository_after
    volumes:
      - .:/app
      - /app/repository_before/node_modules
      - /app/repository_after/node_modules
    command: ["sh", "-c", "cd repository_after && npm test"]

  evaluator:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_after
    container_name: kanban-evaluator
    environment:
      NODE_ENV: production
    volumes:
      - .:/app
      - /app/repository_before/node_modules
      - /app/repository_after/node_modules
    command: ["sh", "-c", "node evaluation/evaluation.js"]
  
  kanban-app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_after
    container_name: kanban-app
    ports:
      - "3000:3000"
      - "3001:3001"
    volumes:
      - .:/app
      - /app/repository_after/node_modules
    command: ["sh", "-c", "cd repository_after && npm run dev"]
