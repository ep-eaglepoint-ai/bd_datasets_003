version: '3.8'

services:
  tester-before:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_before
    container_name: pool-tester-before
    environment:
      TARGET_REPO: repository_before
    volumes:
      - .:/app
    command: ["sh", "-c", "cd repository_before && (mvn test 2>&1 || echo 'Tests failed or no tests found in repository_before') && exit 0"]

  tester-after:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_after
    container_name: pool-tester-after
    environment:
      TARGET_REPO: repository_after
    volumes:
      - .:/app
    command: ["sh", "-c", "cd repository_after && mvn test"]

  evaluator:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        TARGET_REPO: repository_after
    container_name: pool-evaluator
    environment:
      NODE_ENV: production
    volumes:
      - .:/app
    command: ["sh", "-c", "cd evaluation && javac Evaluation.java && java Evaluation"]