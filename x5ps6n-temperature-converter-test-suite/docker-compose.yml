# Docker Compose file for running React tests
services:
  # Run meta tests (tests/) + repository_after/ from root using root Jest and Babel.
  test:
    build: .
    command:
      - sh
      - -c
      - |
        npm ci --silent && \
        npx --yes jest tests/ repository_after/ --config=jest.config.js --watchAll=false --runInBand
    volumes:
      - .:/app
    environment:
      - NODE_ENV=test
      - CI=1
      - REPO=repository_after
    working_dir: /app

  # Runs same /tests (meta tests) on repository_before. Failure is expected (xfailure); exit 0.
  test-before:
    build: .
    command:
      - sh
      - -c
      - |
        npm ci --silent && \
        cp repository_after/TemperatureConverter.test.js repository_before/ && \
        (REPO=repository_before npx --yes jest tests/ repository_before/ --config=jest.config.js --watchAll=false --runInBand --testMatch='**/*.test.js' --testPathIgnorePatterns='App.test.js' || true) && \
        rm repository_before/TemperatureConverter.test.js && \
        echo "" && \
        echo "=== xfail summary ===" && \
        echo "xfail: 55 tests (repository_before expected to fail against repository_after tests)" && \
        echo "=====================" || exit 0
    volumes:
      - .:/app
    environment:
      - NODE_ENV=test
      - CI=1
    working_dir: /app

  evaluate:
    build: .
    command:
      - sh
      - -c
      - |
        npm ci --silent && \
        node evaluation/evaluation.js
    volumes:
      - .:/app
    environment:
      - NODE_ENV=test
      - CI=1
    working_dir: /app
