FROM node:20-slim

WORKDIR /app

# Install minimal system deps used by some Node packages
RUN apt-get update \
  && apt-get install -y --no-install-recommends openssl ca-certificates \
  && rm -rf /var/lib/apt/lists/*

# Install test dependencies
COPY tests/package*.json ./tests/
RUN cd tests && npm ci

# When we run `npm --prefix tests ...` from /app, npm doesn't always
# put /app/tests/node_modules/.bin on PATH in some CI shells.
ENV PATH="/app/tests/node_modules/.bin:${PATH}"

# Copy tests and the implementation-under-test
COPY tests ./tests
COPY repository_after ./repository_after
COPY evaluation ./evaluation

ENV NODE_ENV=test

CMD ["npm", "--prefix", "tests", "run", "test:all"]
